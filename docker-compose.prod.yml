services:
  # Production override intended for use with an external Traefik instance.
  #
  # Requirements:
  # - An external Docker network named `proxy` exists.
  # - Your Traefik container is connected to that `proxy` network.
  #
  # Usage:
  #   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

  # In prod, don't expose internal ports to the host (Traefik is the entrypoint).
  postgres:
    ports: []

  gateway:
    ports: []
    networks:
      - default
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_DOCKER_NETWORK:-proxy}
      - traefik.http.services.gateway.loadbalancer.server.port=8080

      # api.<domain> -> gateway (all paths)
      - traefik.http.routers.api.rule=Host(`${API_HOST}`)
      - traefik.http.routers.api.entrypoints=${TRAEFIK_ENTRYPOINT:-websecure}
      - traefik.http.routers.api.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-le}

      # mini.<domain> -> gateway only for /api/* and /webhook
      - traefik.http.routers.mini_api.rule=Host(`${MINI_HOST}`) && (PathPrefix(`/api`) || Path(`/webhook`))
      - traefik.http.routers.mini_api.entrypoints=${TRAEFIK_ENTRYPOINT:-websecure}
      - traefik.http.routers.mini_api.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-le}
      - traefik.http.routers.mini_api.priority=100

  frontend:
    ports: []
    networks:
      - default
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_DOCKER_NETWORK:-proxy}
      - traefik.http.services.frontend.loadbalancer.server.port=3000

      # mini.<domain> UI (everything else)
      - traefik.http.routers.mini_ui.rule=Host(`${MINI_HOST}`)
      - traefik.http.routers.mini_ui.entrypoints=${TRAEFIK_ENTRYPOINT:-websecure}
      - traefik.http.routers.mini_ui.tls.certresolver=${TRAEFIK_CERT_RESOLVER:-le}
      - traefik.http.routers.mini_ui.priority=1

networks:
  proxy:
    external: true

